---
description: 了解 Swarm 模式下服务的工作方式
keywords: docker, container, cluster, swarm mode, node
title: 服务的工作原理
weight: 20
---

当 Docker Engine 处于 Swarm 模式时，若要部署应用镜像，你需要创建一个服务（service）。服务常见于更大型应用中的某个微服务镜像。例如，HTTP 服务器、数据库，或任何希望在分布式环境中运行的可执行程序，都可以作为服务部署。

创建服务时，你需要指定要使用的容器镜像与在容器内执行的命令。你还可以为服务定义以下配置：

* 将服务暴露到集群外部的端口
* 连接到其他服务所使用的 overlay 网络
* CPU 与内存的限制与预留
* 滚动更新策略
* 在集群中运行的镜像副本数

## 服务、任务与容器

当你将服务部署到集群时，管理节点会将你的服务定义视为该服务的“期望状态”。随后，它会在集群中的节点上调度该服务为一个或多个副本任务（task）。各个任务在不同节点上彼此独立运行。

例如，你希望在三个 HTTP 监听实例之间做负载均衡。下图展示了一个包含 3 个副本的 HTTP 监听服务。这三个实例在 swarm 中分别对应 3 个任务。

![ HTTP listener service with three replicas](../images/services-diagram.webp?w=550)

容器是一个被隔离的进程。在 Swarm 模式下，每个任务严格对应并启动一个容器。可以把任务理解为调度器放置容器的“槽位”。当容器启动后，调度器便认为该任务处于运行状态；若容器健康检查失败或退出，任务也随之结束。

## 任务与调度

任务是 swarm 中的原子调度单元。你通过创建或更新服务来声明期望状态，编排器会通过调度任务来实现该期望状态。比如，你定义一个服务，要求始终保持 3 个 HTTP 监听实例在运行；编排器会创建 3 个任务。每个任务相当于一个由调度器用来生成容器的槽位；容器则是任务的具体实例。如果某个 HTTP 监听任务随后健康检查失败或崩溃，编排器会创建一个新的副本任务并启动新的容器。

任务的生命周期是单向推进的：它会按一定顺序经历 `assigned`、`prepared`、`running` 等状态。如果任务失败，编排器会移除该任务及其容器，并根据服务定义的期望状态创建新的任务来替换。

Swarm 模式的底层逻辑是通用的调度与编排器。服务与任务这两种抽象本身并不感知其具体实现容器这一事实。理论上，也可以实现其他类型的任务，例如虚拟机任务或非容器化的进程任务；调度器与编排器并不关心任务的类型。不过，当前版本的 Docker 仅支持“容器任务”。

下图展示了 Swarm 模式如何接收服务创建请求并将任务调度到工作节点。

![Services flow](../images/service-lifecycle.webp?w=700)

### 挂起中的服务（Pending）

在某些配置下，当前集群内可能没有任何节点可以运行该服务的任务，此时服务会保持在 `pending` 状态。以下是一些导致服务保持 `pending` 的常见场景：

> [!TIP]
> 如果你的目的是暂不部署该服务，更简单的做法是将其副本数缩容为 0，而不是通过配置让服务处于 `pending`。

- 如果所有节点都处于 `paused` 或 `drain` 状态，你此时创建服务，它会一直 `pending`，直至有节点可用。实际上，第一个恢复可用的节点会接收所有任务，因此在生产环境中不建议这样做。

- 你可以为服务预留一定的内存。如果集群中没有任何节点满足该内存需求，服务会保持 `pending`，直到有节点可用。若设置了非常大的值（如 500 GB），除非确实存在能满足的节点，否则任务会一直 `pending`。

- 你可能设置了放置约束（placement constraints），但在某个时刻没有任何节点满足这些约束。

上述行为说明：任务的需求与配置并不与集群的即时状态强绑定。作为 swarm 的管理员，你只需声明你的期望状态，管理节点会与集群中的节点协作去实现该状态；无需对任务进行微观层面的手动干预。

## 副本服务与全局服务

服务部署有两种类型：副本（replicated）与全局（global）。

对于副本服务，你需要指定希望运行的同构任务数。例如，部署一个具有 3 个副本的 HTTP 服务，各副本提供相同内容。

全局服务则会在每个节点上运行一个任务，没有预先指定的任务数量。每当向集群添加节点，编排器都会创建一个任务，调度器将其分配到这个新节点。适合作为全局服务的包括监控代理、病毒扫描器，或任何你希望在集群每个节点上都运行的容器。

下图中，灰色表示 3 副本服务，黑色表示全局服务。

![Global vs replicated services](../images/replicated-vs-global.webp?w=450)

## 延伸阅读

* 了解 Swarm 模式下[节点](nodes.md)的工作方式。
* 了解 Swarm 模式下 [PKI](pki.md) 的工作方式。
